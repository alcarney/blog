
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Passing strings between TinyGo and JavaScript &#8212; Alex Carney</title>

    
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    
    
    
    <link rel="stylesheet" type="text/css" href="../../../_static/css/styles.css" />
    
    
    <link id="pygments_dark_css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css" href="../../../_static/pygments_dark.css" />
    

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" /> 
  </head><body class="flex flex-col justify-between min-h-screen overflow-x-hidden bg-gray-100 dark:bg-gray-900">
    <div class="flex flex-grow">
        <input id="menu-state" type="checkbox" class="hidden" />
        <aside class="flex justify-between flex-shrink-0 transition-all duration-500 bg-white dark:bg-gray-800 -ml-80 lg:ml-0 dark:border-gray-600">
            <div class="flex flex-col justify-between h-full border-r w-80 dark:border-gray-600">
                <div class="sticky top-0 flex flex-col h-screen">

                    <div id="profile-card" class="full-profile">
    <img class="" src="/_static/avatar.jpg"/>
    <h2 class=""><a href="/">Alex Carney</a></h2>
</div>

                    <div id="searchbox" style="display: none" role="search" class="px-4 py-4">
    <form class="flex justify-between px-2 py-1 bg-gray-100 border-2 rounded search dark:bg-gray-900 focus-within:border-green-600 dark:border-gray-600" action="../../../search/" method="get">
        <label class="mr-2 text-gray-500" for="sbox">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search">
                <circle cx="11" cy="11" r="6" />
                <path d="m21 21-4.35-4.35" />
            </svg>
        </label>
        <input id="sbox" class="flex-grow bg-gray-100 dark:text-white dark:bg-gray-900 focus:outline-none" type="search" name="q" placeholder="Search..." aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
    </form>
</div>
<script>$('#searchbox').show(0);</script>

                    

<nav class="flex flex-col text-center">
    <a class="text-green-600 py-1 border-t text-lg hover:bg-gray-50 dark:border-gray-600 dark:hover:bg-gray-900" href="/blog">Blog</a>
    <a class="text-green-600 py-1 border-t text-lg hover:bg-gray-50 dark:border-gray-600 dark:hover:bg-gray-900" href="/code">Code</a>
    <a class="text-green-600 py-1 border-t text-lg hover:bg-gray-50 dark:border-gray-600 dark:hover:bg-gray-900" href="/notes">Notes</a>
</nav>

                    <div class="flex-shrink overflow-auto">

<div class="grid justify-between p-4 text-gray-400 border-t dark:border-gray-600" style="grid-template-columns: 24px auto">
    
    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
</svg>
    <span class="ml-2 text-right">May 06, 2020</span>
    

    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
</svg>
    <ul class="text-right">
        
        <li class="mb-1">
            <a href="../../tag/js/" class="px-2 my-1 text-green-600 border border-green-600 rounded bg-green-50 dark:bg-green-900 dark:text-green-200">
                #js
            </a>
        </li>
        
        <li class="mb-1">
            <a href="../../tag/tinygo/" class="px-2 my-1 text-green-600 border border-green-600 rounded bg-green-50 dark:bg-green-900 dark:text-green-200">
                #tinygo
            </a>
        </li>
        
        <li class="mb-1">
            <a href="../../tag/go/" class="px-2 my-1 text-green-600 border border-green-600 rounded bg-green-50 dark:bg-green-900 dark:text-green-200">
                #go
            </a>
        </li>
        
        <li class="mb-1">
            <a href="../../tag/wasm/" class="px-2 my-1 text-green-600 border border-green-600 rounded bg-green-50 dark:bg-green-900 dark:text-green-200">
                #wasm
            </a>
        </li>
        
    </ul>
</div>
<nav id="localtoc" class="p-4 border-t dark:text-gray-200 dark:border-gray-600">
    <ul>
<li><a class="reference internal" href="#">Passing strings between TinyGo and JavaScript</a><ul>
<li><a class="reference internal" href="#the-interface">The Interface</a></li>
<li><a class="reference internal" href="#passing-strings-from-tinygo-to-javascript">Passing strings from TinyGo to JavaScript</a><ul>
<li><a class="reference internal" href="#digging-deeper">Digging Deeper</a></li>
<li><a class="reference internal" href="#extracting-the-string">Extracting the String</a></li>
</ul>
</li>
<li><a class="reference internal" href="#passing-strings-from-javascript-to-tinygo">Passing strings from JavaScript to TinyGo</a><ul>
<li><a class="reference internal" href="#manipulating-memory">Manipulating Memory</a></li>
<li><a class="reference internal" href="#calling-the-echo-function">Calling the Echo Function</a></li>
</ul>
</li>
<li><a class="reference internal" href="#wrapping-up">Wrapping Up</a></li>
</ul>
</li>
</ul>

</nav>
                    </div>

                    <footer class="w-full p-4 mt-auto text-white bg-gray-700">
                        <div class="flex justify-between">
    <div></div>

    <div class="flex justify-between space-x-4">
        <a target="_blank" rel="noreferrer noopener" href="https://github.com/alcarney">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
            <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/>
          </svg>
        </a>

        <a target="_blank" rel="noreferrer noopener me" href="https://fosstodon.org/@alcarney">
          <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="currentColor">
            <title>Mastodon</title>
            <path d="M23.268 5.313c-.35-2.578-2.617-4.61-5.304-5.004C17.51.242 15.792 0 11.813 0h-.03c-3.98 0-4.835.242-5.288.309C3.882.692 1.496 2.518.917 5.127.64 6.412.61 7.837.661 9.143c.074 1.874.088 3.745.26 5.611.118 1.24.325 2.47.62 3.68.55 2.237 2.777 4.098 4.96 4.857 2.336.792 4.849.923 7.256.38.265-.061.527-.132.786-.213.585-.184 1.27-.39 1.774-.753a.057.057 0 0 0 .023-.043v-1.809a.052.052 0 0 0-.02-.041.053.053 0 0 0-.046-.01 20.282 20.282 0 0 1-4.709.545c-2.73 0-3.463-1.284-3.674-1.818a5.593 5.593 0 0 1-.319-1.433.053.053 0 0 1 .066-.054c1.517.363 3.072.546 4.632.546.376 0 .75 0 1.125-.01 1.57-.044 3.224-.124 4.768-.422.038-.008.077-.015.11-.024 2.435-.464 4.753-1.92 4.989-5.604.008-.145.03-1.52.03-1.67.002-.512.167-3.63-.024-5.545zm-3.748 9.195h-2.561V8.29c0-1.309-.55-1.976-1.67-1.976-1.23 0-1.846.79-1.846 2.35v3.403h-2.546V8.663c0-1.56-.617-2.35-1.848-2.35-1.112 0-1.668.668-1.67 1.977v6.218H4.822V8.102c0-1.31.337-2.35 1.011-3.12.696-.77 1.608-1.164 2.74-1.164 1.311 0 2.302.5 2.962 1.498l.638 1.06.638-1.06c.66-.999 1.65-1.498 2.96-1.498 1.13 0 2.043.395 2.74 1.164.675.77 1.012 1.81 1.012 3.12z"/>
          </svg>
        </a>

        <a target="_blank" rel="noreferrer noopener" href="https://instagram.com/alcarneyme">
          <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="currentColor">
            <title>Instagram</title>
            <path d="M12 0C8.74 0 8.333.015 7.053.072 5.775.132 4.905.333 4.14.63c-.789.306-1.459.717-2.126 1.384S.935 3.35.63 4.14C.333 4.905.131 5.775.072 7.053.012 8.333 0 8.74 0 12s.015 3.667.072 4.947c.06 1.277.261 2.148.558 2.913.306.788.717 1.459 1.384 2.126.667.666 1.336 1.079 2.126 1.384.766.296 1.636.499 2.913.558C8.333 23.988 8.74 24 12 24s3.667-.015 4.947-.072c1.277-.06 2.148-.262 2.913-.558.788-.306 1.459-.718 2.126-1.384.666-.667 1.079-1.335 1.384-2.126.296-.765.499-1.636.558-2.913.06-1.28.072-1.687.072-4.947s-.015-3.667-.072-4.947c-.06-1.277-.262-2.149-.558-2.913-.306-.789-.718-1.459-1.384-2.126C21.319 1.347 20.651.935 19.86.63c-.765-.297-1.636-.499-2.913-.558C15.667.012 15.26 0 12 0zm0 2.16c3.203 0 3.585.016 4.85.071 1.17.055 1.805.249 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.164.422.36 1.057.413 2.227.057 1.266.07 1.646.07 4.85s-.015 3.585-.074 4.85c-.061 1.17-.256 1.805-.421 2.227-.224.562-.479.96-.899 1.382-.419.419-.824.679-1.38.896-.42.164-1.065.36-2.235.413-1.274.057-1.649.07-4.859.07-3.211 0-3.586-.015-4.859-.074-1.171-.061-1.816-.256-2.236-.421-.569-.224-.96-.479-1.379-.899-.421-.419-.69-.824-.9-1.38-.165-.42-.359-1.065-.42-2.235-.045-1.26-.061-1.649-.061-4.844 0-3.196.016-3.586.061-4.861.061-1.17.255-1.814.42-2.234.21-.57.479-.96.9-1.381.419-.419.81-.689 1.379-.898.42-.166 1.051-.361 2.221-.421 1.275-.045 1.65-.06 4.859-.06l.045.03zm0 3.678c-3.405 0-6.162 2.76-6.162 6.162 0 3.405 2.76 6.162 6.162 6.162 3.405 0 6.162-2.76 6.162-6.162 0-3.405-2.76-6.162-6.162-6.162zM12 16c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm7.846-10.405c0 .795-.646 1.44-1.44 1.44-.795 0-1.44-.646-1.44-1.44 0-.794.646-1.439 1.44-1.439.793-.001 1.44.645 1.44 1.439z"/>
          </svg>
        </a>

        <a target="_blank" rel="noreferrer noopener" href="https://www.youtube.com/channel/UC5GPflgRWhnCxA0BllfP5CA">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-8 h-8" fill="currentColor">
            <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
          </svg>
        </a>
    </div>

    <div></div>
</div>
                    </footer>
                </div>
            </div>
        </aside>

        <main class="w-full mx-auto lg:pr-0">
            <div class="sticky top-0 z-50 mt-0 transition-all duration-300 bg-white dark:bg-gray-800 border-b shadow-md lg:shadow-none lg:relative lg:-mt-16 dark:border-gray-600">
                <label class="flex h-16 text-gray-600 transition" for="menu-state">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-8 h-8 my-auto" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                </label>
            </div>

            <div id="content" class="mx-2 my-8">
                <div role="main" class="max-w-3xl mx-auto">
                    

<article class="p-4 prose-sm prose bg-white dark:bg-gray-800 border prose-md prose-emerald max-w-none dark:prose-invert dark:border-gray-600">
    <section id="passing-strings-between-tinygo-and-javascript">
<h1>Passing strings between TinyGo and JavaScript<a class="headerlink" href="#passing-strings-between-tinygo-and-javascript" title="Permalink to this heading">¶</a></h1>
<p>After getting a <a class="reference internal" href="../hello-world-tinygo-wasm/"><span class="doc">“Hello, World!”</span></a> WebAssembly
application working I thought it would be fun to try and implement a toy programming
language in the browser. However before I could even start thinking about parsers,
abstract syntax trees and the like I had to be able to pass strings between my
WebAssembly module and the surrounding JavaScript.</p>
<p>Turns out that is much trickier than I expected.</p>
<div class="admonition-disclaimer admonition">
<p class="admonition-title">Disclaimer</p>
<p>I definitely don’t know what I’m doing, if there’s a better way of doing this I’d love
to know about it! 🙂</p>
</div>
<section id="the-interface">
<h2>The Interface<a class="headerlink" href="#the-interface" title="Permalink to this heading">¶</a></h2>
<figure class="align-center" id="id1">
<img alt="../../../_images/wasm-input-output.png" src="../../../_images/wasm-input-output.png" />
<figcaption>
<p><span class="caption-text">The Interface to our ‘interpreter’</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>Our WebAssembly module needs a way to interact with the user in order both collect input
and show the output. So to start with I updated the webpage from the previous post to
include a number of <code class="docutils literal notranslate"><span class="pre">textarea</span></code> elements and a “Run” button.</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>Input<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">textarea</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;input&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">textarea</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">button</span> <span class="na">disabled</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;run-button&quot;</span><span class="p">&gt;</span>Run<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>Output<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">textarea</span> <span class="na">disabled</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;output&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">textarea</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;log-area&quot;</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">textarea</span> <span class="na">disabled</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;log&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">textarea</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>Now we could just use the <code class="docutils literal notranslate"><span class="pre">println</span></code> function to do the equivalent of a <code class="docutils literal notranslate"><span class="pre">console.log</span></code>
from our TinyGo code but it could be useful to have a log on screen to provide feedback
to the user.</p>
</section>
<section id="passing-strings-from-tinygo-to-javascript">
<h2>Passing strings from TinyGo to JavaScript<a class="headerlink" href="#passing-strings-from-tinygo-to-javascript" title="Permalink to this heading">¶</a></h2>
<p>To achieve this we first need a JavaScript function which takes some text and appends it
to the “log” <code class="docutils literal notranslate"><span class="pre">textarea</span></code> element on screen.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">log</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span><span class="w"></span>

<span class="kd">function</span><span class="w"> </span><span class="nx">logText</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="nx">log</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Next we need some way to reference such a function from our go code. If we define a
function but not implement it TinyGo will recognise it as an external function whose
implementation should be provided by the surrounding JavaScript.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">main</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="nx">log</span><span class="p">(</span><span class="s">&quot;Hello, World!&quot;</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Go tools inside of VSCode will complain about the missing implementation for the
<code class="docutils literal notranslate"><span class="pre">log</span></code> function but TinyGo itself will compile this happily.</p>
</div>
<p>Lastly all we have to do is adjust our wrapping JavaScript code to pass in the
implementation for the <code class="docutils literal notranslate"><span class="pre">log</span></code> function to the module’s environment. While we’re at we
might as well wire up that “Run” button.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="p">...</span><span class="w"></span>

<span class="kd">function</span><span class="w"> </span><span class="nx">onRun</span><span class="p">(</span><span class="nx">runner</span><span class="p">,</span><span class="w"> </span><span class="nx">wasm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">wasm</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">go</span><span class="p">.</span><span class="nx">importObject</span><span class="p">[</span><span class="s2">&quot;main.go.log&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">logText</span><span class="w"></span>

<span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">instantiateStreaming</span><span class="p">(</span><span class="nx">fetch</span><span class="p">(</span><span class="s2">&quot;/js/wisp.wasm&quot;</span><span class="p">),</span><span class="w"> </span><span class="nx">go</span><span class="p">.</span><span class="nx">importObject</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">module</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">wasm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">module</span><span class="p">.</span><span class="nx">instance</span><span class="w"></span>

<span class="w">      </span><span class="nx">runButton</span><span class="p">.</span><span class="nx">disabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">      </span><span class="nx">runButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">onRun</span><span class="p">(</span><span class="nx">go</span><span class="p">,</span><span class="w"> </span><span class="nx">wasm</span><span class="p">))</span><span class="w"></span>
<span class="w">   </span><span class="p">})</span><span class="w"></span>
</pre></div>
</div>
<p>That should be everything connected up, time to give it a whirl!</p>
<figure class="align-center" id="id2">
<img alt="../../../_images/wasm-addr.png" src="../../../_images/wasm-addr.png" />
<figcaption>
<p><span class="caption-text">Not exactly what I had in mind…</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>Hmm… 🤔</p>
<p>This result quickly prompted an extended session of searching around for the “right”
way to pass values back and forth between my WebAssembly module and the surrounding
JavaScript code. Unfortunately I didn’t really come across anything that seemed to work
for me.</p>
<p>I did find that Go has a <a class="reference external" href="https://golang.org/pkg/syscall/js/">syscall/js</a> module which seems to handle exactly this kind of
thing along with a <a class="reference external" href="https://www.aaron-powell.com/posts/2019-02-06-golang-wasm-3-interacting-with-js-from-go/">tutorial series</a> that makes use of it. The problem is that it seems
to fly in the face of the <a class="reference external" href="https://tinygo.org/webassembly/webassembly/">examples</a> (which I did manage to reproduce) on the TinyGo
website where it appears the compiler is handling most of these details.</p>
<p>Unable to find an example to copy I decided it was time for a peek behind the curtain…</p>
<section id="digging-deeper">
<h3>Digging Deeper<a class="headerlink" href="#digging-deeper" title="Permalink to this heading">¶</a></h3>
<p>On my travels I did manage to find out some more information about WebAssembly itself</p>
<ul class="simple">
<li><p>WebAssembly only has basic integer and float <a class="reference external" href="https://webassembly.github.io/spec/core/syntax/types.html">types</a></p></li>
<li><p>A module has its own <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/Memory">memory</a> and is represented by an <code class="docutils literal notranslate"><span class="pre">ArrayBuffer</span></code> in
JavaScript code.</p></li>
</ul>
<p>Before long I had a hunch that the random number that was being displayed in the
<code class="docutils literal notranslate"><span class="pre">textarea</span></code> element was in fact the memory address of the string to be logged. If that
was the case, how should the memory in that location be interpreted so that we’re
able to extract a string from it?</p>
<p>After some more research I discovered that TinyGo is using the <a class="reference external" href="https://llvm.org/">LLVM</a> compiler
toolchain and that you can ask it for the <a class="reference external" href="https://llvm.org/docs/LangRef.html#abstract">intermediate representation</a> which it
passes to LLVM in order to generate the WebAssembly code.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>tinygo build -no-debug -target wasm -printir -o public/js/wisp.wasm main.go &gt; debug.txt
</pre></div>
</div>
<p>Now, there is a <em>lot</em> going on (20,000+ lines) in this file as it includes not just our
simple program but the Go runtime required to execute it. Thankfully with <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">Ctrl</kbd>-<kbd class="kbd docutils literal notranslate">F</kbd></kbd> to
the rescue, it’s easy enough to track down where our “Hello, World!” string is defined</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="p">...</span><span class="w"></span>
<span class="vg">@&quot;main.go.main$string&quot;</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">internal</span><span class="w"> </span><span class="k">unnamed_addr</span><span class="w"> </span><span class="k">constant</span><span class="w"> </span><span class="p">[</span><span class="m">13</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]</span><span class="w"> </span><span class="k">c</span><span class="s">&quot;Hello, World!&quot;</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
</pre></div>
</div>
<p>I don’t know the first thing when it comes to LLVM’s IR representation of code but after
looking into how it thinks about <a class="reference external" href="https://llvm.org/docs/LangRef.html#array-type">arrays</a> we see that <code class="docutils literal notranslate"><span class="pre">[13</span> <span class="pre">x</span> <span class="pre">i8]</span></code> indicates
that our string is represented by an array of 13, 8-bit integers.</p>
<p>Awesome, we now know how to interpret the values we see in the WebAssembly module’s
<code class="docutils literal notranslate"><span class="pre">ArrayBuffer</span></code>, but how will we know how many values to look for?</p>
<p>Let’s try and find our <code class="docutils literal notranslate"><span class="pre">log</span></code> function…</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="k">declare</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@main.go.log</span><span class="p">(</span><span class="kt">i8</span><span class="p">*,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">*,</span><span class="w"> </span><span class="kt">i8</span><span class="p">*)</span><span class="w"></span>
</pre></div>
</div>
<p>Ah, just like the <code class="docutils literal notranslate"><span class="pre">log</span></code> function in our go code it has no implementation since this is
to be provided by the JavaScript wrapper. However instead of a single argument it now
takes 4! Interesting… let’s track down our main function and see how it is used.</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="k">define</span><span class="w"> </span><span class="k">dso_local</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@main.go.main</span><span class="p">(</span><span class="kt">i8</span><span class="p">*</span><span class="w"> </span><span class="nv">%context</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">*</span><span class="w"> </span><span class="nv">%parentHandle</span><span class="p">)</span><span class="w"> </span><span class="k">unnamed_addr</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="nl">entry:</span><span class="w"></span>
<span class="k">call</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@main.go.log</span><span class="p">(</span><span class="kt">i8</span><span class="p">*</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="p">([</span><span class="m">13</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="m">13</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]*</span><span class="w"> </span><span class="vg">@&quot;main.go.main$string&quot;</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">),</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">13</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">*</span><span class="w"> </span><span class="k">undef</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">*</span><span class="w"> </span><span class="k">undef</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="k">ret</span><span class="w"> </span><span class="k">void</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Wow. Umm… there’s a lot going on here… what if we try “squinting” at this code a bit</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="k">define</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@main.go.main</span><span class="p">(...)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="k">call</span><span class="w"> </span><span class="vg">@main.go.log</span><span class="p">(</span><span class="kt">i8</span><span class="p">*</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="p">(...</span><span class="w"> </span><span class="vg">@&quot;main.go.main$string&quot;</span><span class="p">,...),</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">13</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"></span>
<span class="w">   </span><span class="k">ret</span><span class="w"> </span><span class="k">void</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Ok, so it looks like there’s a call being made to our log function and
<a class="reference external" href="https://llvm.org/docs/LangRef.html#i-getelementptr">getelementptr</a> appears to be returning the memory address of our
“Hello, World!” string and look! The <code class="docutils literal notranslate"><span class="pre">i32</span> <span class="pre">13</span></code> argument appears to be passing in its
length! I have no idea what the other arguments are supposed to represent so let’s just
ignore those for now! 😃</p>
<p>Instead why don’t we tweak our <code class="docutils literal notranslate"><span class="pre">logText</span></code> implementation of this function to take a
second argument and see what happens</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">logText</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span><span class="w"> </span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="nx">log</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<figure class="align-center" id="id3">
<img alt="../../../_images/wasm-addr-length.png" src="../../../_images/wasm-addr-length.png" />
<figcaption>
<p><span class="caption-text">That looks promising!</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="extracting-the-string">
<h3>Extracting the String<a class="headerlink" href="#extracting-the-string" title="Permalink to this heading">¶</a></h3>
<p>Assuming our assumptions are correct we should now have all the information we need in
order to extract the string from the WebAssembly module’s memory. <code class="docutils literal notranslate"><span class="pre">ArrayBuffer</span></code> objects
in JavaScript don’t seem to be the most intuitive to work with but I was eventually able
to come up with this.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">logText</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span><span class="w"> </span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wasm</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">memory</span><span class="w"></span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">memory</span><span class="p">.</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span><span class="w"> </span><span class="nx">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">length</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Int8Array</span><span class="p">(</span><span class="nx">bytes</span><span class="p">))</span><span class="w"></span>

<span class="w">   </span><span class="nx">log</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>After getting the reference to the <code class="docutils literal notranslate"><span class="pre">memory</span></code> object we use the <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer/slice">slice</a> method to obtain
a copy of only the bytes that represent our string. Unfortunately bytes on their own are
meaningless unless you know how to interpret them. To enable this there is a whole collection
of <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray">views</a> that can be wrapped around a given array of bytes to attach meaning to them.
From our explorations above we know that we should use an <code class="docutils literal notranslate"><span class="pre">Int8Array</span></code>.</p>
<p>From there we map the <code class="docutils literal notranslate"><span class="pre">String.fromCharCode</span></code> function over the array of ints to convert
them to a string. Finally, we should be able to see our “Hello, World!” string output to
the log area</p>
<figure class="align-center" id="id4">
<img alt="../../../_images/wasm-log-hello.png" src="../../../_images/wasm-log-hello.png" />
<figcaption>
<p><span class="caption-text">Success!</span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>This did require a slight tweak to the way we load the module so that we have a global
<code class="docutils literal notranslate"><span class="pre">wasm</span></code> reference that our <code class="docutils literal notranslate"><span class="pre">logText</span></code> function is able to use to access the module
instance directly.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="nx">wasm</span><span class="w"></span>

<span class="p">...</span><span class="w"></span>

<span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">instantiateStreaming</span><span class="p">(</span><span class="nx">fetch</span><span class="p">(</span><span class="s2">&quot;/js/wisp.wasm&quot;</span><span class="p">),</span><span class="w"> </span><span class="nx">go</span><span class="p">.</span><span class="nx">importObject</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">module</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">wasm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">module</span><span class="p">.</span><span class="nx">instance</span><span class="w"></span>

<span class="w">      </span><span class="nx">runButton</span><span class="p">.</span><span class="nx">disabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">      </span><span class="nx">runButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">onRun</span><span class="p">(</span><span class="nx">go</span><span class="p">,</span><span class="w"> </span><span class="nx">wasm</span><span class="p">))</span><span class="w"></span>
<span class="w">   </span><span class="p">})</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="passing-strings-from-javascript-to-tinygo">
<h2>Passing strings from JavaScript to TinyGo<a class="headerlink" href="#passing-strings-from-javascript-to-tinygo" title="Permalink to this heading">¶</a></h2>
<p>Phew, at least we’re halfway there! Now that we’ve figured out how things actually hang
together it’s “just” a matter of doing the inverse process to pass a string from our
JavaScript code into our WebAssembly module. As a proof of concept let’s create an
<code class="docutils literal notranslate"><span class="pre">echo</span></code> function in TinyGo that will simply log whatever text it receives.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">//go:export echo</span><span class="w"></span>
<span class="kd">func</span><span class="w"> </span><span class="nx">echo</span><span class="p">(</span><span class="nx">message</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>In order to actually pass a string to this function, we need to insert the string into
the memory of the WebAssembly module before calling <code class="docutils literal notranslate"><span class="pre">echo</span></code> with its address and length.</p>
<section id="manipulating-memory">
<h3>Manipulating Memory<a class="headerlink" href="#manipulating-memory" title="Permalink to this heading">¶</a></h3>
<p>The problem is, where exactly in the module’s memory should we place the string? We
can’t shove it anywhere as we could corrupt memory required for some other part of the
program. It is possible to <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/Memory/grow">grow</a> the memory assigned to a module instance
which technically would be free for us to use(?) But it doesn’t exactly <em>feel</em> right,
having two competing codebases manipulate the same memory layout seems to be asking
for trouble…</p>
<p>Thankfully I came across <a class="reference external" href="https://github.com/tinygo-org/tinygo/issues/411#issuecomment-503066868">this comment</a> on an issue in the TinyGo project
which provides a way we can work around this.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">buf</span><span class="w"> </span><span class="p">[</span><span class="mi">1024</span><span class="p">]</span><span class="kt">byte</span><span class="w"></span>

<span class="c1">//go:export getBuffer</span><span class="w"></span>
<span class="kd">func</span><span class="w"> </span><span class="nx">getBuffer</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="kt">byte</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>If we declare an array of bytes in the module, the TinyGo compiler will allocate space
and manage it for us. Then by exporting the <code class="docutils literal notranslate"><span class="pre">getBuffer</span></code> function we provide a way for
our wrapping JavaScript to ask for the address to the region of memory we have reserved
for it. This region of memory should then be safe for us to write to from JavaScript
<strong>provided our go code only reads from this array</strong></p>
<p>Now with some reserved memory to use we can write a function that takes a string and
inserts it into the module’s memory.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">insertText</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">module</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">   </span><span class="c1">// Get the address of the writable memory.</span><span class="w"></span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="nx">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">getBuffer</span><span class="p">()</span><span class="w"></span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="nx">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">buffer</span><span class="w"></span>

<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="nx">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Int8Array</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mem</span><span class="p">.</span><span class="nx">subarray</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span><span class="w"> </span><span class="nx">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"></span>

<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">view</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="c1">// Return the address we started at.</span><span class="w"></span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nx">addr</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>As with the earlier case, we need to create an <code class="docutils literal notranslate"><span class="pre">Int8Array</span></code> in order to attach meaning to
the bytes and so that the numbers representing the characters in the string are encoded
correctly. Also note that we’re using the <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray/subarray">subarray</a> method this time so that we’re
modifying the original array and not a copy.</p>
</section>
<section id="calling-the-echo-function">
<h3>Calling the Echo Function<a class="headerlink" href="#calling-the-echo-function" title="Permalink to this heading">¶</a></h3>
<p>With a way for us to insert the string we want into the module’s memory we should now
be in a position to call the <code class="docutils literal notranslate"><span class="pre">echo</span></code> function passing the starting address and length
of the string we want it to echo. However instead of hardcoding the string this time why
don’t we take it from the input <code class="docutils literal notranslate"><span class="pre">textarea</span></code> we have on the page.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">)</span><span class="w"></span>

<span class="kd">function</span><span class="w"> </span><span class="nx">onRun</span><span class="p">(</span><span class="nx">runner</span><span class="p">,</span><span class="w"> </span><span class="nx">module</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="c1">// First, we need to run the module in order to define everything.</span><span class="w"></span>
<span class="w">      </span><span class="nx">runner</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">module</span><span class="p">)</span><span class="w"></span>

<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">inputText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="w"></span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">insertText</span><span class="p">(</span><span class="nx">inputText</span><span class="p">,</span><span class="w"> </span><span class="nx">module</span><span class="p">)</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Now just pass the memory location to the relevant function.</span><span class="w"></span>
<span class="w">      </span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">echo</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span><span class="w"> </span><span class="nx">inputText</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<figure class="align-center">
<img alt="../../../_images/wasm-echo.gif" src="../../../_images/wasm-echo.gif" />
</figure>
</section>
</section>
<section id="wrapping-up">
<h2>Wrapping Up<a class="headerlink" href="#wrapping-up" title="Permalink to this heading">¶</a></h2>
<p>That’s about it, if you want to have a look at the final codebase then you can find it
<a class="reference external" href="https://github.com/alcarney/wisp/tree/passing-strings">here</a>.</p>
<p>This apparently simple task was certainly a lot more work than I expected it to be,
but if nothing else it’s forced me to learn a bit more about some of the lower-level
details of working with WebAssembly modules.</p>
<p>I don’t think this is necessarily the right approach though.. ok we’re able to pass a
(simple!) string back and forth between our TinyGo code and JavaScript. But there are
more details that still need to be considered</p>
<ul class="simple">
<li><p>This solution does not handle Unicode. There is however a
<a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/API/TextEncoder">TextEncoder</a> API available in the browser that looks like it might
go some way towards fixing this.</p></li>
<li><p>I thought the fixed buffer size in the go module would be an issue - how would you
handle inputs larger than 1024 bytes? However after a quick test with about 5K of text
it seemed to not matter? 🤷 Though I’m sure there’s ways to break it.</p></li>
<li><p>Finally, what about more complex data structures? Sure we’d probably be able to encode
them as JSON and pass them around that way but I’m sure that would introduce
unnecessary overhead.</p></li>
</ul>
<p>And with all that said isn’t this a problem that the toolchain should be solving?
Perhaps I’m just using it wrong 🤔</p>
</section>
</section>

</article>




<div class="mt-8 pt-4 border-t dark:border-gray-600">
    <script src="https://giscus.app/client.js"
            data-repo="alcarney/blog"
            data-repo-id="MDEwOlJlcG9zaXRvcnk2Njk3NzM3MQ=="
            data-category="Comments"
            data-category-id="DIC_kwDOA_3-W84B_XOl"
            data-mapping="pathname"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-theme="preferred_color_scheme"
            crossorigin="anonymous"
            async>
    </script>
</div>



                </div>
            </div>

            <footer class="p-2 mt-8 mb-2 text-sm text-gray-600 border-t dark:border-gray-600">
                <div class="flex flex-col justify-between max-w-3xl mx-auto lg:flex-row">
                    <span>
                        <a class="text-green-600" href="../../../_sources/blog/2020/passing-strings-between-tinygo-wasm.rst.txt" rel="nofollow">
                            Page Source
                        </a>
                    </span>
                    <span>Built with <a class="text-green-600" href="https://www.sphinx-doc.org/en/master/">Sphinx</a> v5.1.1</span>
                    <span>&#169; Copyright 1980, Alex Carney.</span>
                </div>
            </footer>
        </main>

    </div>
<script src="/_static/js/theme.js"></script>


  </body>
</html>